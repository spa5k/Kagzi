syntax = "proto3";
package kagzi.v1;

import "common.proto";
import "workflow.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

// ============================================
// SERVICE
// ============================================

service WorkerService {
  // Lifecycle
  rpc Register(RegisterRequest) returns (RegisterResponse);
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  rpc Deregister(DeregisterRequest) returns (google.protobuf.Empty);

  // Execution
  rpc PollTask(PollTaskRequest) returns (PollTaskResponse);  // Renamed from PollActivity
  rpc BeginStep(BeginStepRequest) returns (BeginStepResponse);
  rpc CompleteStep(CompleteStepRequest) returns (CompleteStepResponse);
  rpc FailStep(FailStepRequest) returns (FailStepResponse);
  rpc CompleteWorkflow(CompleteWorkflowRequest) returns (CompleteWorkflowResponse);
  rpc FailWorkflow(FailWorkflowRequest) returns (FailWorkflowResponse);
  rpc Sleep(SleepRequest) returns (google.protobuf.Empty);
}

// ============================================
// ENUMS
// ============================================

enum WorkerStatus {
  WORKER_STATUS_UNSPECIFIED = 0;
  WORKER_STATUS_ONLINE = 1;
  WORKER_STATUS_DRAINING = 2;
  WORKER_STATUS_OFFLINE = 3;
}

enum StepKind {
  STEP_KIND_UNSPECIFIED = 0;
  STEP_KIND_FUNCTION = 1;
  STEP_KIND_SLEEP = 2;
}

enum StepStatus {
  STEP_STATUS_UNSPECIFIED = 0;
  STEP_STATUS_PENDING = 1;
  STEP_STATUS_RUNNING = 2;
  STEP_STATUS_COMPLETED = 3;
  STEP_STATUS_FAILED = 4;
}

// ============================================
// MESSAGES
// ============================================

message Worker {
  string worker_id = 1;
  string namespace_id = 2;
  string task_queue = 3;
  WorkerStatus status = 4;
  string hostname = 5;
  int32 pid = 6;
  string version = 7;
  repeated string workflow_types = 8;
  int32 max_concurrent = 9;
  int32 active_count = 10;
  int64 total_completed = 11;
  int64 total_failed = 12;
  google.protobuf.Timestamp registered_at = 13;
  google.protobuf.Timestamp last_heartbeat_at = 14;
  map<string, string> labels = 15;
  optional int32 queue_concurrency_limit = 16;
  repeated WorkflowTypeConcurrency workflow_type_concurrency = 17;
}

message WorkflowTypeConcurrency {
  string workflow_type = 1;
  int32 max_concurrent = 2;
}

message Step {
  string step_id = 1;
  string run_id = 2;
  string namespace_id = 3;
  string name = 4;
  StepKind kind = 5;
  StepStatus status = 6;
  int32 attempt_number = 7;
  Payload input = 8;
  Payload output = 9;
  ErrorDetail error = 10;
  google.protobuf.Timestamp created_at = 11;
  google.protobuf.Timestamp started_at = 12;
  google.protobuf.Timestamp finished_at = 13;
  optional string child_run_id = 14;
}

// --- Lifecycle Requests ---

message RegisterRequest {
  string namespace_id = 1;
  string task_queue = 2;
  repeated string workflow_types = 3;
  string hostname = 4;
  int32 pid = 5;
  string version = 6;
  int32 max_concurrent = 7;
  map<string, string> labels = 8;
  optional int32 queue_concurrency_limit = 9;
  repeated WorkflowTypeConcurrency workflow_type_concurrency = 10;
}

message RegisterResponse {
  string worker_id = 1;
  int32 heartbeat_interval_secs = 2;
}

message HeartbeatRequest {
  string worker_id = 1;
  int32 active_count = 2;
  int32 completed_delta = 3;
  int32 failed_delta = 4;
}

message HeartbeatResponse {
  bool accepted = 1;
  bool should_drain = 2;
}

message DeregisterRequest {
  string worker_id = 1;
  bool drain = 2;
}

// --- Execution Requests ---

message PollTaskRequest {
  string worker_id = 1;
  string namespace_id = 2;
  string task_queue = 3;
  repeated string workflow_types = 4;
}

message PollTaskResponse {
  string run_id = 1;
  string workflow_type = 2;
  Payload input = 3;
}

message BeginStepRequest {
  string run_id = 1;
  string step_name = 2;
  StepKind kind = 3;  // Explicit, no more inference
  Payload input = 4;
  RetryPolicy retry_policy = 5;
}

message BeginStepResponse {
  string step_id = 1;
  bool should_execute = 2;
  Payload cached_output = 3;
}

message CompleteStepRequest {
  string run_id = 1;
  string step_id = 2;
  Payload output = 3;
}

message CompleteStepResponse {
  Step step = 1;
}

message FailStepRequest {
  string run_id = 1;
  string step_id = 2;
  ErrorDetail error = 3;
}

message FailStepResponse {
  bool scheduled_retry = 1;
  google.protobuf.Timestamp retry_at = 2;
}

message CompleteWorkflowRequest {
  string run_id = 1;
  Payload output = 2;
}

message CompleteWorkflowResponse {
  WorkflowStatus status = 1;
}

message FailWorkflowRequest {
  string run_id = 1;
  ErrorDetail error = 2;
}

message FailWorkflowResponse {
  WorkflowStatus status = 1;
}

message SleepRequest {
  string run_id = 1;
  string step_id = 2;
  uint64 duration_seconds = 3;
}

