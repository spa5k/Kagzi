syntax = "proto3";
package kagzi.v1;

import "common.proto";
import "google/protobuf/timestamp.proto";
import "workflow.proto";

// WorkflowScheduleService manages cron-based automatic workflow execution.
service WorkflowScheduleService {
  // CreateWorkflowSchedule creates a new cron schedule that automatically starts workflows.
  rpc CreateWorkflowSchedule(CreateWorkflowScheduleRequest) returns (CreateWorkflowScheduleResponse);
  // GetWorkflowSchedule retrieves a schedule by its ID.
  rpc GetWorkflowSchedule(GetWorkflowScheduleRequest) returns (GetWorkflowScheduleResponse);
  // ListWorkflowSchedules returns paginated schedules with optional task queue filtering.
  rpc ListWorkflowSchedules(ListWorkflowSchedulesRequest) returns (ListWorkflowSchedulesResponse);
  // UpdateWorkflowSchedule modifies an existing schedule's configuration.
  rpc UpdateWorkflowSchedule(UpdateWorkflowScheduleRequest) returns (UpdateWorkflowScheduleResponse);
  // DeleteWorkflowSchedule permanently removes a schedule.
  rpc DeleteWorkflowSchedule(DeleteWorkflowScheduleRequest) returns (DeleteWorkflowScheduleResponse);
  // TriggerWorkflowSchedule immediately fires a schedule outside its normal cron interval.
  rpc TriggerWorkflowSchedule(TriggerWorkflowScheduleRequest) returns (TriggerWorkflowScheduleResponse);
  // PauseWorkflowSchedule temporarily disables automatic execution.
  rpc PauseWorkflowSchedule(PauseWorkflowScheduleRequest) returns (PauseWorkflowScheduleResponse);
  // ResumeWorkflowSchedule re-enables a paused schedule.
  rpc ResumeWorkflowSchedule(ResumeWorkflowScheduleRequest) returns (ResumeWorkflowScheduleResponse);
  // ListScheduleRuns returns workflow executions triggered by this schedule.
  rpc ListScheduleRuns(ListScheduleRunsRequest) returns (ListScheduleRunsResponse);
}

// WorkflowSchedule represents a cron schedule with execution statistics.
message WorkflowSchedule {
  string namespace_id = 1;
  string schedule_id = 2;
  string task_queue = 3;
  string workflow_type = 4;
  string cron_expr = 5;
  string version = 6;
  bool enabled = 7;
  Payload input = 8;
  int32 max_catchup = 9;
  int64 total_runs = 10;
  int64 successful_runs = 11;
  int64 failed_runs = 12;
  google.protobuf.Timestamp created_at = 13;
  google.protobuf.Timestamp updated_at = 14;
  optional google.protobuf.Timestamp next_fire_at = 15;
  optional google.protobuf.Timestamp last_fired_at = 16;
}

// CreateWorkflowScheduleRequest defines a cron expression and workflow configuration.
message CreateWorkflowScheduleRequest {
  string namespace_id = 1;
  string task_queue = 2;
  string workflow_type = 3;
  string cron_expr = 4;
  Payload input = 5;
  optional bool enabled = 6;
  optional int32 max_catchup = 7;
  optional string version = 8;
}

message CreateWorkflowScheduleResponse {
  WorkflowSchedule schedule = 1;
}

message GetWorkflowScheduleRequest {
  string namespace_id = 1;
  string schedule_id = 2;
}

message GetWorkflowScheduleResponse {
  WorkflowSchedule schedule = 1;
}

message ListWorkflowSchedulesRequest {
  string namespace_id = 1;
  optional string task_queue = 2;
  PageRequest page = 3;
}

message ListWorkflowSchedulesResponse {
  repeated WorkflowSchedule schedules = 1;
  PageInfo page = 2;
}

// UpdateWorkflowScheduleRequest allows modification of any schedule field.
message UpdateWorkflowScheduleRequest {
  string namespace_id = 1;
  string schedule_id = 2;
  optional string task_queue = 3;
  optional string workflow_type = 4;
  optional string cron_expr = 5;
  optional Payload input = 6;
  optional bool enabled = 7;
  optional int32 max_catchup = 8;
  optional google.protobuf.Timestamp next_fire_at = 9;
  optional string version = 10;
}

message UpdateWorkflowScheduleResponse {
  WorkflowSchedule schedule = 1;
}

message DeleteWorkflowScheduleRequest {
  string namespace_id = 1;
  string schedule_id = 2;
}

message DeleteWorkflowScheduleResponse {
  bool deleted = 1;
  string message = 2;
}

message TriggerWorkflowScheduleRequest {
  string namespace_id = 1;
  string schedule_id = 2;
}

message TriggerWorkflowScheduleResponse {
  string run_id = 1;
}

message PauseWorkflowScheduleRequest {
  string namespace_id = 1;
  string schedule_id = 2;
}

message PauseWorkflowScheduleResponse {
  WorkflowSchedule schedule = 1;
}

message ResumeWorkflowScheduleRequest {
  string namespace_id = 1;
  string schedule_id = 2;
}

message ResumeWorkflowScheduleResponse {
  WorkflowSchedule schedule = 1;
}

message ListScheduleRunsRequest {
  string namespace_id = 1;
  string schedule_id = 2;
  PageRequest page = 3;
}

message ListScheduleRunsResponse {
  repeated Workflow runs = 1;
  PageInfo page = 2;
}
