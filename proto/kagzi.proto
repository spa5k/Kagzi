syntax = "proto3";
package kagzi;

import "google/protobuf/timestamp.proto";

service WorkflowService {
  // --- Client/Trigger Facing API ---
  rpc StartWorkflow (StartWorkflowRequest) returns (StartWorkflowResponse);
  rpc GetWorkflowRun (GetWorkflowRunRequest) returns (GetWorkflowRunResponse);
  rpc ListWorkflowRuns (ListWorkflowRunsRequest) returns (ListWorkflowRunsResponse);
  rpc CancelWorkflowRun (CancelWorkflowRunRequest) returns (Empty);

  // --- Step Attempt API ---
  rpc GetStepAttempt (GetStepAttemptRequest) returns (GetStepAttemptResponse);
  rpc ListStepAttempts (ListStepAttemptsRequest) returns (ListStepAttemptsResponse);

  // --- Worker Facing API ---
  // Worker calls this to ask for work. Blocks until work is available or timeout.
  rpc PollActivity (PollActivityRequest) returns (PollActivityResponse);
  
  // Worker sends this periodically to keep the lock on the workflow run
  rpc RecordHeartbeat (RecordHeartbeatRequest) returns (Empty);

  // Worker asks: "Has this step run before?"
  rpc BeginStep (BeginStepRequest) returns (BeginStepResponse);

  // Worker says: "Step finished successfully"
  rpc CompleteStep (CompleteStepRequest) returns (Empty);

  // Worker says: "Step failed"
  rpc FailStep (FailStepRequest) returns (Empty);

  // Worker says: "Workflow finished"
  rpc CompleteWorkflow (CompleteWorkflowRequest) returns (Empty);
  
  // Worker says: "Workflow failed explicitly"
  rpc FailWorkflow (FailWorkflowRequest) returns (Empty);

  // Worker says: "I need to sleep"
  rpc ScheduleSleep (ScheduleSleepRequest) returns (Empty);

  // --- Health & Monitoring API ---
  rpc HealthCheck (HealthCheckRequest) returns (HealthCheckResponse);
}

// --- Enums ---

enum WorkflowStatus {
  WORKFLOW_STATUS_UNSPECIFIED = 0;
  WORKFLOW_STATUS_PENDING = 1;
  WORKFLOW_STATUS_RUNNING = 2;
  WORKFLOW_STATUS_SLEEPING = 3;
  WORKFLOW_STATUS_COMPLETED = 4;
  WORKFLOW_STATUS_FAILED = 5;
  WORKFLOW_STATUS_CANCELLED = 6;
}

enum StepKind {
  STEP_KIND_UNSPECIFIED = 0;
  STEP_KIND_FUNCTION = 1;
  STEP_KIND_SLEEP = 2;
}

enum StepAttemptStatus {
  STEP_ATTEMPT_STATUS_UNSPECIFIED = 0;
  STEP_ATTEMPT_STATUS_PENDING = 1;
  STEP_ATTEMPT_STATUS_RUNNING = 2;
  STEP_ATTEMPT_STATUS_COMPLETED = 3;
  STEP_ATTEMPT_STATUS_FAILED = 4;
}

enum ErrorCode {
  ERROR_CODE_UNSPECIFIED = 0;
  ERROR_CODE_WORKFLOW_NOT_FOUND = 1;
  ERROR_CODE_STEP_ALREADY_COMPLETED = 2;
  ERROR_CODE_INVALID_ARGUMENT = 3;
  ERROR_CODE_INTERNAL = 4;
}

// --- Core Objects ---

message WorkflowRun {
  string run_id = 1;
  string business_id = 2;
  string task_queue = 3;
  string workflow_type = 4;
  WorkflowStatus status = 5;
  
  // Inputs and Outputs
  // We use bytes to allow raw JSON or other serialization formats
  bytes input = 6;
  bytes output = 7;
  string error = 8;
  
  // Metadata
  int32 attempts = 9;
  
  // Timestamps
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp started_at = 11;
  google.protobuf.Timestamp finished_at = 12;
  google.protobuf.Timestamp wake_up_at = 13;

  // New fields
  string namespace_id = 14;
  bytes context = 15;
  google.protobuf.Timestamp deadline_at = 16;
  string worker_id = 17; // Read-only, from server
  string version = 18;
  string parent_step_attempt_id = 19;
}

message StepAttempt {
  string step_attempt_id = 1;
  string workflow_run_id = 2;
  string step_id = 3;
  StepKind kind = 4;
  StepAttemptStatus status = 5;
  bytes config = 6;
  bytes context = 7;
  bytes output = 8;
  bytes error = 9;
  google.protobuf.Timestamp started_at = 10;
  google.protobuf.Timestamp finished_at = 11;
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
  string child_workflow_run_id = 14;
  string namespace_id = 15;
}

// --- Requests / Responses ---

message StartWorkflowRequest {
  string workflow_id = 1;    // Business ID (e.g., "order-123")
  string task_queue = 2;     // Who handles this?
  string workflow_type = 3;  // Which function?
  bytes input = 4;           // JSON payload as bytes
  
  // New fields
  string namespace_id = 5;
  string idempotency_key = 6;
  bytes context = 7;
  google.protobuf.Timestamp deadline_at = 8;
  string version = 9;
}

message StartWorkflowResponse {
  string run_id = 1;
}

message GetWorkflowRunRequest {
  string run_id = 1;
  string namespace_id = 2;
}

message GetWorkflowRunResponse {
  WorkflowRun workflow_run = 1;
}

message ListWorkflowRunsRequest {
  int32 page_size = 1;
  string page_token = 2;
  string filter_status = 3; // Optional: Filter by status string (e.g. "RUNNING")
  string namespace_id = 4;
}

message ListWorkflowRunsResponse {
  repeated WorkflowRun workflow_runs = 1;
  string next_page_token = 2;
  string prev_page_token = 3;
  bool has_more = 4;
}

message CancelWorkflowRunRequest {
  string run_id = 1;
  string namespace_id = 2;
}

message GetStepAttemptRequest {
  string step_attempt_id = 1;
  string namespace_id = 2;
}

message GetStepAttemptResponse {
  StepAttempt step_attempt = 1;
}

message ListStepAttemptsRequest {
  string workflow_run_id = 1;
  string step_id = 2; // Optional
  int32 page_size = 3;
  string page_token = 4;
  string namespace_id = 5;
}

message ListStepAttemptsResponse {
  repeated StepAttempt step_attempts = 1;
  string next_page_token = 2;
}

message PollActivityRequest {
  string task_queue = 1;
  string worker_id = 2;
  string namespace_id = 3;
}

message PollActivityResponse {
  string run_id = 1;
  string workflow_type = 2;
  bytes workflow_input = 3;
}

message RecordHeartbeatRequest {
  string run_id = 1;
  string worker_id = 2;
}

message BeginStepRequest {
  string run_id = 1;
  string step_id = 2;
  bytes input = 3;  // Optional: Step input for recording
}

message BeginStepResponse {
  bool should_execute = 1; // If false, use cached_result
  bytes cached_result = 2;
}

message CompleteStepRequest {
  string run_id = 1;
  string step_id = 2;
  bytes output = 3;
}

message FailStepRequest {
  string run_id = 1;
  string step_id = 2;
  string error = 3;
}

message CompleteWorkflowRequest {
  string run_id = 1;
  bytes output = 2;
}

message FailWorkflowRequest {
  string run_id = 1;
  string error = 2;
}

message ScheduleSleepRequest {
  string run_id = 1;
  uint64 duration_seconds = 2;
}

// --- Health Check Messages ---

message HealthCheckRequest {
  string service = 1; // Optional service name to check
}

message HealthCheckResponse {
  enum ServingStatus {
    SERVING_STATUS_UNSPECIFIED = 0;
    SERVING = 1;
    NOT_SERVING = 2;
    SERVICE_UNKNOWN = 3;  // Used only by the Watch method.
  }
  ServingStatus status = 1;
  string message = 2; // Optional details about the status
  google.protobuf.Timestamp timestamp = 3;
}

// Standard empty message
message Empty {}
