syntax = "proto3";
package kagzi;

import "google/protobuf/timestamp.proto";

service WorkflowService {
  // --- Client/Trigger Facing API ---
  rpc StartWorkflow (StartWorkflowRequest) returns (StartWorkflowResponse);
  rpc GetWorkflowRun (GetWorkflowRunRequest) returns (GetWorkflowRunResponse);
  rpc ListWorkflowRuns (ListWorkflowRunsRequest) returns (ListWorkflowRunsResponse);
  rpc CancelWorkflowRun (CancelWorkflowRunRequest) returns (Empty);

  // --- Step Attempt API ---
  rpc GetStepAttempt (GetStepAttemptRequest) returns (GetStepAttemptResponse);
  rpc ListStepAttempts (ListStepAttemptsRequest) returns (ListStepAttemptsResponse);

  // --- Worker Lifecycle API ---
  rpc RegisterWorker(RegisterWorkerRequest) returns (RegisterWorkerResponse);
  rpc WorkerHeartbeat(WorkerHeartbeatRequest) returns (WorkerHeartbeatResponse);
  rpc DeregisterWorker(DeregisterWorkerRequest) returns (Empty);

  // --- Worker Discovery API ---
  rpc ListWorkers(ListWorkersRequest) returns (ListWorkersResponse);
  rpc GetWorker(GetWorkerRequest) returns (GetWorkerResponse);

  // --- Worker Execution API (requires registration) ---
  // Worker calls this to ask for work. Blocks until work is available or timeout.
  rpc PollActivity (PollActivityRequest) returns (PollActivityResponse);

  // Worker asks: "Has this step run before?"
  rpc BeginStep (BeginStepRequest) returns (BeginStepResponse);

  // Worker says: "Step finished successfully"
  rpc CompleteStep (CompleteStepRequest) returns (Empty);

  // Worker says: "Step failed"
  rpc FailStep (FailStepRequest) returns (Empty);

  // Worker says: "Workflow finished"
  rpc CompleteWorkflow (CompleteWorkflowRequest) returns (Empty);
  
  // Worker says: "Workflow failed explicitly"
  rpc FailWorkflow (FailWorkflowRequest) returns (Empty);

  // Worker says: "I need to sleep"
  rpc ScheduleSleep (ScheduleSleepRequest) returns (Empty);

  // --- Health & Monitoring API ---
  rpc HealthCheck (HealthCheckRequest) returns (HealthCheckResponse);
}

// --- Enums ---

enum WorkflowStatus {
  WORKFLOW_STATUS_UNSPECIFIED = 0;
  WORKFLOW_STATUS_PENDING = 1;
  WORKFLOW_STATUS_RUNNING = 2;
  WORKFLOW_STATUS_SLEEPING = 3;
  WORKFLOW_STATUS_COMPLETED = 4;
  WORKFLOW_STATUS_FAILED = 5;
  WORKFLOW_STATUS_CANCELLED = 6;
}

enum StepKind {
  STEP_KIND_UNSPECIFIED = 0;
  STEP_KIND_FUNCTION = 1;
  STEP_KIND_SLEEP = 2;
}

enum StepAttemptStatus {
  STEP_ATTEMPT_STATUS_UNSPECIFIED = 0;
  STEP_ATTEMPT_STATUS_PENDING = 1;
  STEP_ATTEMPT_STATUS_RUNNING = 2;
  STEP_ATTEMPT_STATUS_COMPLETED = 3;
  STEP_ATTEMPT_STATUS_FAILED = 4;
}

enum WorkerStatus {
  WORKER_STATUS_UNSPECIFIED = 0;
  WORKER_STATUS_ONLINE = 1;      // Accepting and processing work
  WORKER_STATUS_DRAINING = 2;    // Finishing existing, rejecting new
  WORKER_STATUS_OFFLINE = 3;     // Not available
}

enum ErrorCode {
  ERROR_CODE_UNSPECIFIED = 0;
  ERROR_CODE_WORKFLOW_NOT_FOUND = 1;
  ERROR_CODE_STEP_ALREADY_COMPLETED = 2;
  ERROR_CODE_INVALID_ARGUMENT = 3;
  ERROR_CODE_INTERNAL = 4;
}

// --- Core Objects ---

message WorkflowRun {
  string run_id = 1;
  string business_id = 2;
  string task_queue = 3;
  string workflow_type = 4;
  WorkflowStatus status = 5;
  
  // Inputs and Outputs
  // We use bytes to allow raw JSON or other serialization formats
  bytes input = 6;
  bytes output = 7;
  string error = 8;
  
  // Metadata
  int32 attempts = 9;
  
  // Timestamps
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp started_at = 11;
  google.protobuf.Timestamp finished_at = 12;
  google.protobuf.Timestamp wake_up_at = 13;

  // New fields
  string namespace_id = 14;
  bytes context = 15;
  google.protobuf.Timestamp deadline_at = 16;
  string worker_id = 17; // Read-only, from server
  string version = 18;
  string parent_step_attempt_id = 19;
}

message StepAttempt {
  string step_attempt_id = 1;
  string workflow_run_id = 2;
  string step_id = 3;
  StepKind kind = 4;
  StepAttemptStatus status = 5;
  bytes config = 6;
  bytes context = 7;
  bytes output = 8;
  bytes error = 9;
  google.protobuf.Timestamp started_at = 10;
  google.protobuf.Timestamp finished_at = 11;
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
  string child_workflow_run_id = 14;
  string namespace_id = 15;
}

// --- Requests / Responses ---

message RetryPolicy {
  int32 maximum_attempts = 1;           // default: 5, -1 = unlimited
  int64 initial_interval_ms = 2;        // default: 1000
  double backoff_coefficient = 3;       // default: 2.0
  int64 maximum_interval_ms = 4;        // default: 60000
  repeated string non_retryable_errors = 5;
}

message StartWorkflowRequest {
  string workflow_id = 1;    // Business ID (e.g., "order-123")
  string task_queue = 2;     // Who handles this?
  string workflow_type = 3;  // Which function?
  bytes input = 4;           // JSON payload as bytes
  
  // New fields
  string namespace_id = 5;
  string idempotency_key = 6;
  bytes context = 7;
  google.protobuf.Timestamp deadline_at = 8;
  string version = 9;
  RetryPolicy retry_policy = 10;
}

message StartWorkflowResponse {
  string run_id = 1;
}

message GetWorkflowRunRequest {
  string run_id = 1;
  string namespace_id = 2;
}

message GetWorkflowRunResponse {
  WorkflowRun workflow_run = 1;
}

message ListWorkflowRunsRequest {
  int32 page_size = 1;
  string page_token = 2;
  string filter_status = 3; // Optional: Filter by status string (e.g. "RUNNING")
  string namespace_id = 4;
}

message ListWorkflowRunsResponse {
  repeated WorkflowRun workflow_runs = 1;
  string next_page_token = 2;
  string prev_page_token = 3;
  bool has_more = 4;
}

message CancelWorkflowRunRequest {
  string run_id = 1;
  string namespace_id = 2;
}

message GetStepAttemptRequest {
  string step_attempt_id = 1;
  string namespace_id = 2;
}

message GetStepAttemptResponse {
  StepAttempt step_attempt = 1;
}

message ListStepAttemptsRequest {
  string workflow_run_id = 1;
  string step_id = 2; // Optional
  int32 page_size = 3;
  string page_token = 4;
  string namespace_id = 5;
}

message ListStepAttemptsResponse {
  repeated StepAttempt step_attempts = 1;
  string next_page_token = 2;
}

message PollActivityRequest {
  string task_queue = 1;
  string worker_id = 2;           // Must be from RegisterWorkerResponse
  string namespace_id = 3;
  repeated string supported_workflow_types = 4;
}

message PollActivityResponse {
  string run_id = 1;
  string workflow_type = 2;
  bytes workflow_input = 3;
}

message BeginStepRequest {
  string run_id = 1;
  string step_id = 2;
  bytes input = 3;  // Optional: Step input for recording
  RetryPolicy retry_policy = 4;
}

message BeginStepResponse {
  bool should_execute = 1; // If false, use cached_result
  bytes cached_result = 2;
}

message CompleteStepRequest {
  string run_id = 1;
  string step_id = 2;
  bytes output = 3;
}

message FailStepRequest {
  string run_id = 1;
  string step_id = 2;
  string error = 3;
  bool non_retryable = 4;
  int64 retry_after_ms = 5;
}

message CompleteWorkflowRequest {
  string run_id = 1;
  bytes output = 2;
}

message FailWorkflowRequest {
  string run_id = 1;
  string error = 2;
}

message ScheduleSleepRequest {
  string run_id = 1;
  uint64 duration_seconds = 2;
}

// --- Health Check Messages ---

message HealthCheckRequest {
  string service = 1; // Optional service name to check
}

message HealthCheckResponse {
  enum ServingStatus {
    SERVING_STATUS_UNSPECIFIED = 0;
    SERVING = 1;
    NOT_SERVING = 2;
    SERVICE_UNKNOWN = 3;  // Used only by the Watch method.
  }
  ServingStatus status = 1;
  string message = 2; // Optional details about the status
  google.protobuf.Timestamp timestamp = 3;
}

// Standard empty message
message Empty {}

// --- Worker Registry Messages ---

message Worker {
  string worker_id = 1;
  string namespace_id = 2;
  string task_queue = 3;
  WorkerStatus status = 4;

  string hostname = 5;
  int32 pid = 6;
  string version = 7;

  repeated string workflow_types = 8;
  int32 max_concurrent = 9;
  int32 active_count = 10;

  int64 total_completed = 11;
  int64 total_failed = 12;

  google.protobuf.Timestamp registered_at = 13;
  google.protobuf.Timestamp last_heartbeat_at = 14;

  map<string, string> labels = 15;
}

message RegisterWorkerRequest {
  string namespace_id = 1;
  string task_queue = 2;
  repeated string workflow_types = 3;

  string hostname = 4;
  int32 pid = 5;
  string version = 6;
  int32 max_concurrent = 7;
  map<string, string> labels = 8;
}

message RegisterWorkerResponse {
  string worker_id = 1;
  int32 heartbeat_interval_secs = 2;
}

message WorkerHeartbeatRequest {
  string worker_id = 1;
  int32 active_count = 2;
  int32 completed_delta = 3;
  int32 failed_delta = 4;
}

message WorkerHeartbeatResponse {
  bool accepted = 1;
  bool should_drain = 2;
}

message DeregisterWorkerRequest {
  string worker_id = 1;
  bool drain = 2;
}

message ListWorkersRequest {
  string namespace_id = 1;
  string task_queue = 2;       // Optional filter
  string filter_status = 3;    // Optional: ONLINE, DRAINING, OFFLINE
  int32 page_size = 4;
  string page_token = 5;
}

message ListWorkersResponse {
  repeated Worker workers = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message GetWorkerRequest {
  string worker_id = 1;
}

message GetWorkerResponse {
  Worker worker = 1;
}
