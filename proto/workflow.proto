syntax = "proto3";
package kagzi.v1;

import "common.proto";
import "google/protobuf/timestamp.proto";

// WorkflowService manages the full workflow lifecycle from creation to completion.
// All operations are namespace-isolated for multi-tenancy.
service WorkflowService {
  // StartWorkflow initiates a new workflow execution using external_id for idempotency.
  rpc StartWorkflow(StartWorkflowRequest) returns (StartWorkflowResponse);
  // GetWorkflow retrieves a workflow by its unique run_id.
  rpc GetWorkflow(GetWorkflowRequest) returns (GetWorkflowResponse);
  // GetWorkflowByExternalId retrieves a workflow using the user-provided idempotency key.
  rpc GetWorkflowByExternalId(GetWorkflowByExternalIdRequest) returns (GetWorkflowByExternalIdResponse);
  // ListWorkflows returns paginated workflows with optional filtering by status, type, and date range.
  rpc ListWorkflows(ListWorkflowsRequest) returns (ListWorkflowsResponse);
  // CancelWorkflow attempts graceful cancellation of a running workflow.
  rpc CancelWorkflow(CancelWorkflowRequest) returns (CancelWorkflowResponse);
  // RetryWorkflow creates a new execution for a failed workflow with the same input.
  rpc RetryWorkflow(RetryWorkflowRequest) returns (RetryWorkflowResponse);
  // TerminateWorkflow forcefully stops a workflow with a termination reason.
  rpc TerminateWorkflow(TerminateWorkflowRequest) returns (TerminateWorkflowResponse);
}

enum WorkflowStatus {
  WORKFLOW_STATUS_UNSPECIFIED = 0;
  WORKFLOW_STATUS_PENDING = 1;
  WORKFLOW_STATUS_RUNNING = 2;
  WORKFLOW_STATUS_SLEEPING = 3;
  WORKFLOW_STATUS_COMPLETED = 4;
  WORKFLOW_STATUS_FAILED = 5;
  WORKFLOW_STATUS_CANCELLED = 6;
  WORKFLOW_STATUS_SCHEDULED = 7;
  WORKFLOW_STATUS_PAUSED = 8;
}

// Workflow represents a workflow execution instance with its current state and metadata.
message Workflow {
  string namespace = 1;
  string run_id = 2;
  string external_id = 3;
  string task_queue = 4;
  string workflow_type = 5;
  WorkflowStatus status = 6;
  string version = 7;
  Payload input = 8;
  optional Payload output = 9;
  optional ErrorDetail error = 10;
  int32 attempts = 11;
  optional int32 priority = 12;
  optional int64 timeout_ms = 13;
  google.protobuf.Timestamp created_at = 14;
  optional google.protobuf.Timestamp started_at = 15;
  optional google.protobuf.Timestamp finished_at = 16;
  optional google.protobuf.Timestamp wake_up_at = 17;
  optional string worker_id = 18;
  optional string parent_run_id = 19;
  optional string parent_step_id = 20;
  optional string schedule_id = 21;
  optional string cron_expr = 22;
}

// StartWorkflowRequest initiates a workflow with idempotency via external_id.
message StartWorkflowRequest {
  string namespace = 1;
  string external_id = 2;
  string task_queue = 3;
  string workflow_type = 4;
  Payload input = 5;
  string version = 7;
  RetryPolicy retry_policy = 8;
}

// StartWorkflowResponse returns run_id and indicates if this was a duplicate request.
message StartWorkflowResponse {
  string run_id = 1;
  bool already_exists = 2;
}

message GetWorkflowRequest {
  string namespace = 1;
  string run_id = 2;
}

message GetWorkflowResponse {
  Workflow workflow = 1;
}

// ListWorkflowsRequest supports filtering by status, type, queue, and date range.
message ListWorkflowsRequest {
  string namespace = 1;
  optional WorkflowStatus status_filter = 2;
  PageRequest page = 3;
  optional string workflow_type = 4;
  optional string task_queue = 5;
  optional google.protobuf.Timestamp created_after = 6;
  optional google.protobuf.Timestamp created_before = 7;
}

message ListWorkflowsResponse {
  repeated Workflow workflows = 1;
  PageInfo page = 2;
}

message CancelWorkflowRequest {
  string namespace = 1;
  string run_id = 2;
}

// CancelWorkflowResponse indicates if cancellation succeeded and the resulting status.
message CancelWorkflowResponse {
  bool cancelled = 1;
  WorkflowStatus status = 2;
}

message RetryWorkflowRequest {
  string namespace = 1;
  string run_id = 2;
}

// RetryWorkflowResponse returns the new run_id or indicates the workflow is still running.
message RetryWorkflowResponse {
  string new_run_id = 1;
  bool already_running = 2;
}

message GetWorkflowByExternalIdRequest {
  string namespace = 1;
  string external_id = 2;
}

message GetWorkflowByExternalIdResponse {
  Workflow workflow = 1;
}

message TerminateWorkflowRequest {
  string namespace = 1;
  string run_id = 2;
  string reason = 3;
}

message TerminateWorkflowResponse {
  bool terminated = 1;
  WorkflowStatus status = 2;
}
